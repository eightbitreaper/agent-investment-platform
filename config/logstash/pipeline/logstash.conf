input {
  # Receive logs from log streaming server
  http {
    host => "0.0.0.0"
    port => 5000
    codec => json
    add_field => { "source" => "platform_logs" }
  }

  # Receive beats input for file-based logging
  beats {
    port => 5044
  }

  # TCP input for direct log shipping
  tcp {
    port => 5001
    codec => json_lines
    add_field => { "source" => "tcp_logs" }
  }
}

filter {
  # Parse timestamp
  if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
  }

  # Add computed fields
  mutate {
    add_field => {
      "log_day" => "%{+YYYY.MM.dd}"
      "log_hour" => "%{+HH}"
    }
  }

  # Parse component and service information
  if [component] {
    mutate {
      add_field => { "service" => "%{component}" }
    }
  }

  # Extract error information
  if [level] == "ERROR" or [level] == "CRITICAL" {
    mutate {
      add_tag => [ "error" ]
    }
  }

  # Parse exception information
  if [exception] {
    mutate {
      add_field => {
        "exception_type" => "%{[exception][type]}"
        "exception_message" => "%{[exception][message]}"
      }
    }
  }

  # Extract trace and span IDs for distributed tracing
  if [trace_id] {
    mutate {
      add_field => { "tracing_trace_id" => "%{trace_id}" }
    }
  }

  if [span_id] {
    mutate {
      add_field => { "tracing_span_id" => "%{span_id}" }
    }
  }

  # Performance metrics
  if [duration_ms] {
    mutate {
      convert => { "duration_ms" => "float" }
    }
  }

  # Geolocate based on hostname if possible
  # This would be expanded with actual GeoIP lookup in production

  # Drop empty fields
  mutate {
    remove_field => [ "host" ]
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "investment-platform-logs-%{+YYYY.MM.dd}"
  }

  # Debug output (remove in production)
  stdout {
    codec => rubydebug
  }

  # Send errors to a separate index for alerting
  if "error" in [tags] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "investment-platform-errors-%{+YYYY.MM.dd}"
    }
  }

  # Send performance metrics to a separate index
  if [duration_ms] {
    elasticsearch {
      hosts => ["elasticsearch:9200"]
      index => "investment-platform-performance-%{+YYYY.MM.dd}"
    }
  }
}
